<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ViboSonic - Genre Prediction</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Inter&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>

<body class="bg-gradient-to-tr from-gray-900 via-black to-gray-900 text-white min-h-screen flex items-center justify-center">
  <div class="main-glass-box w-full max-w-2xl p-8 glassmorphism-effect rounded-3xl shadow-2xl">
    <!-- <h1 class="text-5xl font-orbitron text-center mb-10 text-indigo-400 tracking-wider">ViboSonic</h1> -->
    <p class="text-center text-lg font-semibold text-indigo-300 italic mb-6 quote-style">
       | Feel the music. Classify the magic. |
    </p>
    

    <form id="uploadForm" class="flex flex-col items-center space-y-6">
      <label for="audioFile" class="file-label">
        <span class="file-label-text"> Upload an audio file </span>
        <input type="file" id="audioFile" name="file" accept="audio/*" required class="file-input hidden" />
      </label>

      <div id="selectedFile" class="selected-file hidden"></div>
      <button type="submit" class="upload-btn">Predict Genre</button>

      <!-- <button type="submit" class="upload-btn">ðŸ”Ž Predict Genre</button> -->
    </form>

    <div id="status" class="text-indigo-300 mt-6 hidden text-center">Analyzing audio... ðŸŽ¶</div>
    <div id="error" class="text-red-400 mt-2 hidden text-center"></div>

    <!-- Result Box with Glass Effect -->
    <div id="resultBox" class="mt-10 p-6 rounded-xl glassmorphism-effect hidden">
      <p class="text-xl font-semibold text-center mb-4">Genre Prediction Results</p>
      <canvas id="genreChart" class="mb-6"></canvas>
      <div id="genreLabels" class="flex flex-wrap justify-center gap-3"></div>
    </div>
    
    <button id="downloadBtn" class="download-btn hidden mx-auto mt-4">Download Report (PDF)</button>
    
    </div>
    
    <script src="script.js"> </script>
    <script>
      const form = document.getElementById("uploadForm");
      const statusDiv = document.getElementById("status");
      const errorDiv = document.getElementById("error");
      const genreChart = document.getElementById("genreChart");
      const genreLabelsDiv = document.getElementById("genreLabels");
      const resultBox = document.getElementById("resultBox");
      const selectedFile = document.getElementById("selectedFile");
      let chartInstance = null;
    
      document.getElementById("audioFile").addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          selectedFile.textContent = ` ðŸŽµ Selected File : ${file.name} ðŸŽµ`;
          selectedFile.classList.remove("hidden");
        } else {
          selectedFile.classList.add("hidden");
        }
      });
    
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusDiv.classList.remove("hidden");
        errorDiv.classList.add("hidden");
        resultBox.classList.add("hidden");
    
        const formData = new FormData();
        formData.append("file", document.getElementById("audioFile").files[0]);
    
        try {
          const response = await fetch("/predict", {
            method: "POST",
            body: formData,
          });
    
          const data = await response.json();
          statusDiv.classList.add("hidden");
    
          if (data.error) {
            errorDiv.textContent = data.error;
            errorDiv.classList.remove("hidden");
          } else {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const colors = [
              "#6366f1", "#3b82f6", "#06b6d4", "#10b981",
              "#84cc16", "#f59e0b", "#ef4444", "#8b5cf6",
              "#ec4899", "#0ea5e9"
            ];
    
            if (chartInstance) chartInstance.destroy();
    
            chartInstance = new Chart(genreChart, {
              type: "pie",
              data: {
                labels: labels,
                datasets: [{
                  label: "Genre Match %",
                  data: values,
                  backgroundColor: colors,
                  borderColor: "#1f2937",
                  borderWidth: 2,
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  tooltip: {
                    callbacks: {
                      label: ctx => `${ctx.label}: ${ctx.raw.toFixed(2)}%`
                    }
                  },
                  legend: { display: false }
                }
              }
            });
    
            genreLabelsDiv.innerHTML = labels.map((label, i) =>
              `<div class="genre-label-item" style="color:${colors[i]};">
                <span class="genre-dot" style="background:${colors[i]};"></span>${label}
              </div>`).join("");
    
            resultBox.classList.remove("hidden");
            downloadBtn.classList.remove("hidden");
          }
    
        } catch (err) {
          statusDiv.classList.add("hidden");
          errorDiv.textContent = "An error occurred. Please try again.";
          errorDiv.classList.remove("hidden");
        }
      });
    
      const downloadBtn = document.getElementById("downloadBtn");
      document.getElementById("downloadBtn").addEventListener("click", async () => {
        const { jsPDF } = window.jspdf;
        const fileInput = document.getElementById("audioFile");
        const fileName = fileInput.files[0]?.name || "Unknown File";

        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        pdf.setLineWidth(1); 

        // Border
        pdf.setDrawColor(180);
        pdf.rect(10, 10, pageWidth - 20, pageHeight - 20);

        pdf.setLineWidth(0.2); 

        // Title
        pdf.setFont("Helvetica", "bold");
        pdf.setFontSize(18);
        pdf.text("ViboSonic Genre Prediction Report", pageWidth / 2, 20, { align: "center" });

        // Thin divider below title
        pdf.setDrawColor(200);
        pdf.line(20, 24, pageWidth - 20, 24);

        // File info
        pdf.setFont("Helvetica", "normal");
        pdf.setFontSize(12);
        pdf.text("Audio File:", 20, 32);
        pdf.setFont("Helvetica", "bold");
        pdf.text(fileName, 45, 32);

        // Divider below file info
        pdf.setDrawColor(200);
        pdf.line(20, 36, pageWidth - 20, 36);

        // === Pie Chart Section ===
        const chartCanvas = document.getElementById("genreChart");
        const chartImage = chartCanvas.toDataURL("image/png", 1.0);
        const chartWidth = 90;
        const chartHeight = 90;
        pdf.addImage(chartImage, "PNG", (pageWidth - chartWidth) / 2, 42, chartWidth, chartHeight);

        let y = 42 + chartHeight + 8;

        // Thin divider between chart and details
        pdf.setDrawColor(220);
        pdf.line(20, y, pageWidth - 20, y);
        y += 6;

        // Section title + description
        pdf.setFont("Helvetica", "bold");
        pdf.setFontSize(13);
        pdf.text("Genre Prediction Breakdown", 20, y);
        y += 7;

        pdf.setFont("Helvetica", "normal");
        pdf.setFontSize(11);
        const description = "This section shows the predicted genres for your uploaded music file, visualized through a pie chart and listed below with their associated confidence percentages.";
        const splitDescription = pdf.splitTextToSize(description, pageWidth - 40);
        pdf.text(splitDescription, 20, y);
        y += splitDescription.length * 6 + 4;

        // === Genre Details List ===
        const chart = Chart.getChart("genreChart");
        const labels = chart.data.labels;
        const data = chart.data.datasets[0].data;
        const colors = chart.data.datasets[0].backgroundColor;

        pdf.setFontSize(11);
        pdf.setTextColor(0);

        for (let i = 0; i < labels.length; i++) {
          if (y > pageHeight - 20) {
            pdf.addPage();
            y = 20;
          }

          // Colored dot
          pdf.setFillColor(colors[i]);
          pdf.circle(22, y - 2, 2, "F");

          // Genre + %
          pdf.setFont("Helvetica", "normal");
          pdf.text(`${labels[i]}`, 28, y);

          pdf.setFont("Helvetica", "bold");
          pdf.text(`${data[i].toFixed(2)}%`, pageWidth - 20, y, { align: "right" });

          y += 7.2; // tighter row height
        }

        pdf.save("ViboSonic_Genre_Report.pdf");
      });

    </script>
  
    <nav class="navbar glassmorphism-effect w-full py-4 shadow-md fixed top-0 left-0 z-50">
      <div class="text-center">
        <h1 class="text-2xl font-orbitron text-indigo-300 tracking-widest">
          ViboSonic <span class="font-sans text-indigo-100">: An audio genre classification system</span>
        </h1>
      </div>
    </nav>
  
  </body>
</html>